{% extends 'base.html' %}
{% block content %}
<div class="container section panel center-form-wrapper">
    <div class="center-form">
        <h3 style="margin-top: 0; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; color: #2c3e50;">
            <i data-lucide="{% if budget %}plus-circle{% else %}credit-card{% endif %}" style="width:28px;height:28px; color: #ff9800;"></i>
            {% if budget %}New Budget Entry for <span style="color: #f57c00;">{{ budget.name }}</span>{% else %}Create New Budget{% endif %}
        </h3>

        <form method="POST" enctype="multipart/form-data">
            {% if not budget %}
                <!-- Create new budget form -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">Budget Name *</label>
                    <input type="text" name="name" class="form-control" placeholder="e.g., SK General Fund, Youth Programs Fund, etc." required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 15px;">
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">Initial Amount</label>
                    <input type="number" name="initial_amount" step="0.01" min="0" class="form-control" placeholder="0.00" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 15px;">
                    <small style="color: #6c757d; font-size: 13px; margin-top: 5px; display: block;">Optional starting amount for this budget</small>
                </div>
            {% else %}
                <!-- Create budget entry form -->
                <input type="hidden" name="budget_id" value="{{ budget.id }}">
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #34495e; font-size: 16px;">Entry Type *</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <label style="display: flex; flex-direction: column; padding: 20px; border: 2px solid #28a745; border-radius: 10px; cursor: pointer; background: #f8f9fa; transition: all 0.3s ease; position: relative; overflow: hidden;">
                            <input type="radio" name="entry_type" value="increase" required style="position: absolute; opacity: 0;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                <div style="width: 24px; height: 24px; border: 2px solid #28a745; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <div style="width: 12px; height: 12px; background: #28a745; border-radius: 50%; display: none;"></div>
                                </div>
                                <div>
                                    <div style="font-weight: 700; color: #28a745; font-size: 16px;">Increase (Income)</div>
                                    <small style="color: #6c757d; font-size: 13px;">Add funds to budget</small>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; color: #28a745; font-size: 14px;">
                                <i data-lucide="trending-up" style="width: 18px; height: 18px;"></i>
                                <span>Funds added to balance</span>
                            </div>
                        </label>
                        
                        <label style="display: flex; flex-direction: column; padding: 20px; border: 2px solid #dc3545; border-radius: 10px; cursor: pointer; background: #f8f9fa; transition: all 0.3s ease; position: relative; overflow: hidden;">
                            <input type="radio" name="entry_type" value="decrease" required style="position: absolute; opacity: 0;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                <div style="width: 24px; height: 24px; border: 2px solid #dc3545; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <div style="width: 12px; height: 12px; background: #dc3545; border-radius: 50%; display: none;"></div>
                                </div>
                                <div>
                                    <div style="font-weight: 700; color: #dc3545; font-size: 16px;">Decrease (Expense)</div>
                                    <small style="color: #6c757d; font-size: 13px;">Remove funds from budget</small>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; color: #dc3545; font-size: 14px;">
                                <i data-lucide="trending-down" style="width: 18px; height: 18px;"></i>
                                <span>Funds deducted from balance</span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">Amount *</label>
                        <input type="number" name="amount" step="0.01" min="0.01" class="form-control" placeholder="0.00" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; font-weight: 600;">
                        {% if budget.current_balance > 0 %}
                            <div style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #ff9800;">
                                <div style="font-size: 13px; color: #6c757d;">Current balance:</div>
                                <div style="font-size: 18px; font-weight: 700; color: #2c3e50;">â‚±{{ "%.2f"|format(budget.current_balance|float) }}</div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">Date</label>
                        <input type="date" name="entry_date" class="form-control" value="{{ datetime.now().strftime('%Y-%m-%d') if datetime else '' }}" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 15px;">
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">Description *</label>
                    <textarea name="description" class="form-control" placeholder="Enter detailed description of this transaction..." required rows="4" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 15px; resize: vertical;"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">Evidence (Optional)</label>
                        <div style="border: 2px dashed #adb5bd; border-radius: 8px; padding: 20px; text-align: center; background: #f8f9fa; cursor: pointer; position: relative;">
                            <input type="file" name="evidence" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-control" style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; top: 0; left: 0;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                <i data-lucide="upload" style="width: 32px; height: 32px; color: #6c757d;"></i>
                                <div>
                                    <div style="color: #ff9800; font-weight: 600;">Browse...</div>
                                    <div style="color: #6c757d; font-size: 13px; margin-top: 5px;">No file selected</div>
                                </div>
                            </div>
                        </div>
                        <small style="color: #6c757d; font-size: 13px; margin-top: 8px; display: block;">Upload receipt or supporting document</small>
                    </div>
                    
                    {% if projects %}
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">Link to Project (Optional)</label>
                        <select name="project_id" class="form-control" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 15px; background-color: white;">
                            <option value="">-- Select Project --</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                        <small style="color: #6c757d; font-size: 13px; margin-top: 8px; display: block;">Link this transaction to a specific project</small>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Approval notice -->
                <div style="padding: 20px; background: #fff3cd; border-radius: 10px; margin-bottom: 25px; border: 1px solid #ffd54f;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <i data-lucide="alert-circle" style="width: 22px; height: 22px; color: #ff9800; flex-shrink: 0; margin-top: 2px;"></i>
                        <div>
                            <div style="font-weight: 700; color: #f57c00; font-size: 16px; margin-bottom: 8px;">
                                Approval Notice
                            </div>
                            <div style="color: #856404; font-size: 14px; line-height: 1.5;">
                                {% if session.user.role in ['Treasurer', 'BMO'] %}
                                <p style="margin: 0 0 8px 0;">
                                    <i data-lucide="clock" style="width: 16px; height: 16px; vertical-align: middle; color: #f57c00;"></i>
                                    Your entries will require approval from the SK Chairman before affecting the budget balance.
                                </p>
                                <p style="margin: 0; font-size: 13px;">
                                    <i data-lucide="info" style="width: 14px; height: 14px; vertical-align: middle; color: #ff9800;"></i>
                                    The transaction will be recorded but won't update the balance until approved.
                                </p>
                                {% else %}
                                <p style="margin: 0;">
                                    <i data-lucide="check-circle" style="width: 16px; height: 16px; vertical-align: middle; color: #28a745;"></i>
                                    Your entries will be automatically approved and immediately affect the budget balance.
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User signature -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <div style="color: #6c757d; font-size: 14px;">
                        <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">
                            <i data-lucide="user" style="width: 16px; height: 16px; vertical-align: middle; color: #ff9800;"></i>
                            {{ session.user.fullname }}
                        </div>
                        <div style="font-size: 13px;">
                            <i data-lucide="briefcase" style="width: 14px; height: 14px; vertical-align: middle; color: #f57c00;"></i>
                            {{ session.user.role }}
                        </div>
                    </div>
                </div>
            {% endif %}
            
            <!-- Action buttons -->
            <div style="display: flex; gap: 15px; margin-top: 40px; padding-top: 25px; border-top: 1px solid #e0e0e0;">
                <button type="submit" class="btn-primary" style="flex: 1; padding: 16px 30px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s ease;">
                    <i data-lucide="save" style="width: 20px; height: 20px;"></i>
                    {% if budget %}Create Entry{% else %}Create Budget{% endif %}
                </button>
                
                <a href="{% if budget %}{{ url_for('budget_details', budget_id=budget.id) }}{% else %}{{ url_for('budgets') }}{% endif %}?sidebar=open" class="btn-secondary" style="flex: 0.4; padding: 16px 25px; background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 16px; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s ease;">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<style>
.center-form-wrapper {
    display: flex;
    justify-content: center;
    width: 100%;
    padding: 20px;
}

.center-form {
    width: 100%;
    max-width: 900px;
    background: #ffffff;
    border-radius: 16px;
    padding: 40px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    border: 1px solid #e0e0e0;
}

.form-control {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 15px;
    transition: all 0.3s ease;
    background-color: white;
}

.form-control:focus {
    border-color: #ff9800;
    outline: none;
    box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.15);
}

/* Radio button selection styling */
input[name="entry_type"]:checked + div > div > div:first-child > div:last-child {
    display: flex !important;
}

input[name="entry_type"]:checked + div {
    border-width: 3px;
    background: #f8f9fa;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

input[name="entry_type"][value="increase"]:checked + div {
    border-color: #28a745;
    background: #f0f9f0;
}

input[name="entry_type"][value="decrease"]:checked + div {
    border-color: #dc3545;
    background: #fdf0f0;
}

/* Button hover effects */
.btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(255, 152, 0, 0.4);
}

.btn-secondary:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
    
    // Set max date to today
    const dateInput = document.querySelector('input[name="entry_date"]');
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.max = today;
        
        // If no value is set, set it to today
        if (!dateInput.value) {
            dateInput.value = today;
        }
    }
    
    // Improve radio button selection visual feedback
    const radioLabels = document.querySelectorAll('label[style*="border: 2px solid"]');
    radioLabels.forEach(label => {
        const radioInput = label.querySelector('input[type="radio"]');
        
        // Add click feedback
        label.addEventListener('click', function() {
            // Remove visual selection from all labels
            radioLabels.forEach(l => {
                l.style.transform = '';
                l.style.boxShadow = '';
                l.style.background = '#f8f9fa';
            });
            
            // Add visual feedback to clicked label
            this.style.transform = 'translateY(-3px)';
            this.style.boxShadow = '0 8px 20px rgba(0, 0, 0, 0.15)';
            if (this.querySelector('input[type="radio"]').value === 'increase') {
                this.style.background = '#f0f9f0';
            } else {
                this.style.background = '#fdf0f0';
            }
        });
        
        // Update visual state when radio is checked
        radioInput.addEventListener('change', function() {
            radioLabels.forEach(l => {
                l.style.transform = '';
                l.style.boxShadow = '';
                l.style.background = '#f8f9fa';
            });
            if (this.checked) {
                label.style.transform = 'translateY(-3px)';
                if (this.value === 'increase') {
                    label.style.boxShadow = '0 8px 20px rgba(40, 167, 69, 0.3)';
                    label.style.background = '#f0f9f0';
                } else {
                    label.style.boxShadow = '0 8px 20px rgba(220, 53, 69, 0.3)';
                    label.style.background = '#fdf0f0';
                }
            }
        });
    });
    
    // File upload visual feedback
    const fileInput = document.querySelector('input[name="evidence"]');
    if (fileInput) {
        const fileUploadArea = fileInput.parentElement;
        const fileNameDisplay = fileUploadArea.querySelector('div:nth-child(2) > div:nth-child(2) > div:last-child');
        
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                const fileName = this.files[0].name;
                fileNameDisplay.textContent = fileName;
                fileNameDisplay.style.color = '#28a745';
                fileNameDisplay.style.fontWeight = '600';
                fileUploadArea.style.borderColor = '#28a745';
                fileUploadArea.style.background = '#f0f9f0';
            } else {
                fileNameDisplay.textContent = 'No file selected';
                fileNameDisplay.style.color = '#6c757d';
                fileNameDisplay.style.fontWeight = 'normal';
                fileUploadArea.style.borderColor = '#adb5bd';
                fileUploadArea.style.background = '#f8f9fa';
            }
        });
        
        // Drag and drop effects
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ff9800';
            this.style.background = '#fff3e0';
        });
        
        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '#adb5bd';
            this.style.background = '#f8f9fa';
        });
    }
});
</script>
{% endblock %}