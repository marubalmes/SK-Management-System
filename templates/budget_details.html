{% extends 'base.html' %}
{% block content %}
<div class="container section panel">
  <!-- Header -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div>
      <h3 style="margin: 0 0 5px 0;">{{ budget.name }}</h3>
      <p style="margin: 0; color: #6c757d;">Created: {{ budget.created_at.strftime('%B %d, %Y') }}</p>
    </div>
    <div style="display: flex; gap: 10px;">
      {% if session.user.role != 'Secretary' %}
        <a class="btn" href="{{ url_for('new_budget_entry', budget_id=budget.id) }}?sidebar=open">
          <i data-lucide="plus-circle" style="width:16px;height:16px;"></i> New Entry
        </a>
      {% endif %}
      <a class="btn btn-secondary" href="{{ url_for('budgets') }}?sidebar=open">
        <i data-lucide="arrow-left" style="width:16px;height:16px;"></i> Back to Budgets
      </a>
    </div>
  </div>

  <!-- Budget Summary -->
  <div class="card" style="margin-bottom: 20px;">
    <h4 style="margin-top: 0; display: flex; align-items: center; gap: 8px; margin-bottom: 20px;">
      <i data-lucide="bar-chart-3" style="width:18px;height:18px;"></i>
      Budget Summary
    </h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
      <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="font-size: 1.8em; font-weight: bold; color: #495057;">₱{{ "%.2f"|format(budget.total_amount|float) }}</div>
        <div style="color: #495057; font-weight: 600;">Total Allocated</div>
      </div>
      <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #e6f4ea 0%, #d4edda 100%); border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="font-size: 1.8em; font-weight: bold; color: #28a745;">₱{{ "%.2f"|format(stats.total_income|float) }}</div>
        <div style="color: #155724; font-weight: 600;">Total Income</div>
      </div>
      <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="font-size: 1.8em; font-weight: bold; color: #dc3545;">₱{{ "%.2f"|format(stats.total_expenses|float) }}</div>
        <div style="color: #721c24; font-weight: 600;">Total Expenses</div>
      </div>
      <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, {% if budget.current_balance > 0 %}#e6f4ea{% else %}#f8d7da{% endif %} 0%, {% if budget.current_balance > 0 %}#d4edda{% else %}#f5c6cb{% endif %} 100%); border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="font-size: 1.8em; font-weight: bold; color: {% if budget.current_balance > 0 %}#155724{% else %}#721c24{% endif %};">₱{{ "%.2f"|format(budget.current_balance|float) }}</div>
        <div style="color: {% if budget.current_balance > 0 %}#155724{% else %}#721c24{% endif %}; font-weight: 600;">Current Balance</div>
      </div>
    </div>
  </div>

  <!-- Two-column layout -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <!-- Left: Budget Entries -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
          <i data-lucide="list" style="width:18px;height:18px;"></i>
          Budget Entries
        </h4>
        <span class="status-badge {% if stats.pending_count > 0 %}status-pending{% else %}status-approved{% endif %}">
          {{ stats.pending_count }} pending
        </span>
      </div>
      
      <div style="max-height: 400px; overflow-y: auto;">
        {% if entries %}
          {% for entry in entries %}
          <div style="padding: 12px; border-bottom: 1px solid #e9ecef; transition: all 0.2s ease; border-left: 4px solid {% if entry.status == 'approved' %}{% if entry.entry_type == 'increase' %}#28a745{% else %}#dc3545{% endif %}{% elif entry.status == 'pending' %}#ffc107{% else %}#6c757d{% endif %};">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div>
                <div style="font-weight: 500; color: #333;">{{ entry.description }}</div>
                <div style="font-size: 0.85em; color: #6c757d;">
                  {{ entry.entry_date.strftime('%b %d, %Y') }} • 
                  {{ entry.creator_name }}
                  {% if entry.approver_name %}
                    • Approved by: {{ entry.approver_name }}
                  {% endif %}
                </div>
                {% if entry.evidence_filename %}
                  <div style="margin-top: 6px;">
                    <a href="{{ url_for('uploaded_file', filename=entry.evidence_filename.replace('uploads/','')) }}" target="_blank" style="display: inline-flex; align-items: center; gap: 4px; font-size: 0.85em; color: #f57c00;">
                      <i data-lucide="paperclip" style="width:12px;height:12px;"></i> View Receipt
                    </a>
                  </div>
                {% endif %}
              </div>
              <div style="text-align: right;">
                <div style="font-weight: 700; color: {% if entry.entry_type == 'increase' %}#28a745{% else %}#dc3545{% endif %};">
                  {% if entry.entry_type == 'increase' %}+{% else %}-{% endif %}₱{{ "%.2f"|format(entry.amount|float) }}
                </div>
                <span class="status-badge status-{{ entry.status }}" style="margin-top: 4px; display: inline-block;">
                  {{ entry.status|upper }}
                </span>
              </div>
            </div>
            
            {% if entry.status == 'pending' and session.user.role == 'SK_Chairman' %}
            <div style="display: flex; gap: 8px; margin-top: 10px;">
              <form method="POST" action="{{ url_for('approve_budget_entry', budget_id=budget.id, entry_id=entry.id) }}" style="display: inline;">
                <button type="submit" class="btn-outline" style="border-color: #28a745; color: #28a745; padding: 4px 8px; font-size: 0.85em;">
                  <i data-lucide="check" style="width:12px;height:12px;"></i> Approve
                </button>
              </form>
              <form method="POST" action="{{ url_for('reject_budget_entry', budget_id=budget.id, entry_id=entry.id) }}" style="display: inline;">
                <button type="submit" class="btn-outline" style="border-color: #dc3545; color: #dc3545; padding: 4px 8px; font-size: 0.85em;">
                  <i data-lucide="x" style="width:12px;height:12px;"></i> Reject
                </button>
              </form>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
          <div style="text-align: center; padding: 30px; color: #6c757d;">
            <i data-lucide="list" style="width:48px;height:48px; opacity:0.5; margin-bottom:10px;"></i>
            <p>No budget entries yet</p>
            {% if session.user.role != 'Secretary' %}
              <a class="btn" href="{{ url_for('new_budget_entry', budget_id=budget.id) }}?sidebar=open" style="margin-top: 10px;">
                <i data-lucide="plus-circle" style="width:16px;height:16px;"></i> Add First Entry
              </a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>

<!-- Right: Project Allocations & Activity -->
<div style="display: flex; flex-direction: column; gap: 20px;">
  <!-- Project Allocations -->
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
        <i data-lucide="folder" style="width:18px;height:18px;"></i>
        Project Allocations
      </h4>
      {% if session.user.role in ['SK_Chairman', 'Treasurer', 'BMO', 'super_admin'] %}
        <button onclick="showAllocationForm()" class="btn-outline" style="padding: 6px 10px;">
          <i data-lucide="plus" style="width:14px;height:14px;"></i> Allocate
        </button>
      {% endif %}
    </div>
    
    <!-- Allocation Form (Hidden by default) -->
    <div id="allocationForm" style="display: none; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
    <form method="POST" action="{{ url_for('allocate_project_budget', budget_id=budget.id) }}">
        <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Project</label>
        <select name="project_id" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;" required>
            <option value="">-- Select Project --</option>
            {% for project in projects %}
            <!-- Filter out projects already linked to this budget -->
            {% set is_linked = false %}
            {% for allocation in project_allocations %}
                {% if allocation.project_id == project.id and allocation.status == 'approved' %}
                {% set is_linked = true %}
                {% endif %}
            {% endfor %}
            {% if not is_linked %}
                <option value="{{ project.id }}">{{ project.name }}</option>
            {% endif %}
            {% endfor %}
        </select>
        </div>
        <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Amount to Allocate</label>
        <input type="number" name="amount" step="0.01" min="0.01" 
                class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;" 
                placeholder="Enter amount" required>
        <small style="color: #6c757d;">Available balance: ₱{{ "%.2f"|format(budget.current_balance|float) }}</small>
        </div>
        <div style="display: flex; gap: 10px;">
        <button type="submit" class="btn" style="padding: 8px 16px;">
            <i data-lucide="save" style="width:14px;height:14px;"></i> Create Allocation
        </button>
        <button type="button" onclick="hideAllocationForm()" class="btn btn-secondary" style="padding: 8px 16px;">
            <i data-lucide="x" style="width:14px;height:14px;"></i> Cancel
        </button>
        </div>
    </form>
    </div>
    
    {% if project_allocations %}
      <div style="max-height: 200px; overflow-y: auto;">
        {% for allocation in project_allocations %}
        <div style="padding: 10px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-weight: 500; color: #333;">{{ allocation.project_name }}</div>
            <div style="font-size: 0.85em; color: #6c757d;">
              {{ allocation.project_status }} • 
              Allocated: {{ allocation.created_at.strftime('%b %d, %Y') }}
              {% if allocation.status %}
                • <span class="status-badge status-{{ allocation.status }}" style="margin-left: 5px;">
                  {{ allocation.status|upper }}
                </span>
              {% endif %}
            </div>
          </div>
          <div style="text-align: right;">
            <div style="font-weight: 700; color: #495057;">₱{{ "%.2f"|format(allocation.allocated_amount|float) }}</div>
            <div style="font-size: 0.85em; color: #6c757d;">Used: ₱{{ "%.2f"|format(allocation.used_amount|float) }}</div>
            {% if allocation.status == 'pending' and session.user.role == 'SK_Chairman' %}
              <div style="display: flex; gap: 5px; margin-top: 5px;">
                <form method="POST" action="{{ url_for('approve_project_allocation', budget_id=budget.id, allocation_id=allocation.id) }}" style="display: inline;">
                  <button type="submit" class="btn-outline" style="border-color: #28a745; color: #28a745; padding: 3px 6px; font-size: 0.7em;">
                    <i data-lucide="check" style="width:10px;height:10px;"></i> Approve
                  </button>
                </form>
                <form method="POST" action="{{ url_for('reject_project_allocation', budget_id=budget.id, allocation_id=allocation.id) }}" style="display: inline;">
                  <button type="submit" class="btn-outline" style="border-color: #dc3545; color: #dc3545; padding: 3px 6px; font-size: 0.7em;">
                    <i data-lucide="x" style="width:10px;height:10px;"></i> Reject
                  </button>
                </form>
              </div>
            {% elif allocation.status == 'pending' %}
              <div style="font-size: 0.7em; color: #856404; margin-top: 5px;">Pending Approval</div>
            {% elif session.user.role in ['SK_Chairman', 'Treasurer', 'BMO', 'super_admin'] and allocation.status == 'approved' %}
              <a href="{{ url_for('delete_project_allocation', budget_id=budget.id, allocation_id=allocation.id) }}" 
                 onclick="return confirm('Remove this project allocation? The amount will be returned to the budget.')"
                 style="color: #dc3545; font-size: 0.85em; text-decoration: none; display: block; margin-top: 5px;">
                <i data-lucide="trash-2" style="width:12px;height:12px;"></i> Remove
              </a>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div style="text-align: center; padding: 20px; color: #6c757d;">
        <i data-lucide="folder" style="width:32px;height:32px; opacity:0.5; margin-bottom:10px;"></i>
        <p>No project allocations yet</p>
      </div>
    {% endif %}
  </div>

      <!-- Recent Activity -->
      <div class="card">
        <h4 style="margin-top: 0; display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
          <i data-lucide="activity" style="width:18px;height:18px;"></i>
          Recent Activity
        </h4>
        <div style="max-height: 200px; overflow-y: auto;">
          {% if activity_history %}
            {% for activity in activity_history %}
            <div style="padding: 8px; border-bottom: 1px solid #e9ecef;">
              <div style="font-size: 0.85em; color: #333; margin-bottom: 2px;">{{ activity.description }}</div>
              <div style="font-size: 0.75em; color: #6c757d;">
                {{ activity.performer_name }} • {{ activity.performed_at.strftime('%b %d, %I:%M %p') }}
                {% if activity.amount_changed and activity.amount_changed > 0 %}
                  • <span style="color: {% if 'increase' in activity.description or 'created' in activity.description %}#28a745{% else %}#dc3545{% endif %};">
                    ₱{{ "%.2f"|format(activity.amount_changed|float) }}
                  </span>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div style="text-align: center; padding: 20px; color: #6c757d;">
              <i data-lucide="activity" style="width:32px;height:32px; opacity:0.5; margin-bottom:10px;"></i>
              <p>No recent activity</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.btn {
  background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  text-decoration: none;
  font-size: 0.9em;
}

.btn-secondary {
  background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
}

.btn-outline {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  border: 1px solid #ff9800;
  border-radius: 6px;
  color: #ff9800;
  text-decoration: none;
  font-weight: 500;
  font-size: 0.85em;
  background: white;
  cursor: pointer;
}

.btn-outline:hover {
  background: #ff9800;
  color: white;
}

.status-badge {
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.7em;
  font-weight: bold;
  display: inline-block;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-approved { background: #d4edda; color: #155724; }
.status-rejected { background: #f8d7da; color: #721c24; }
</style>

<script>
    
function openEditModal(budgetId, entryId) {
  // Fetch modal content
  fetch(`/budgets/${budgetId}/entries/${entryId}/edit_modal?sidebar=open`)
    .then(response => response.text())
    .then(html => {
      // Create modal container if it doesn't exist
      let modalContainer = document.getElementById('editBudgetModalContainer');
      if (!modalContainer) {
        modalContainer = document.createElement('div');
        modalContainer.id = 'editBudgetModalContainer';
        document.body.appendChild(modalContainer);
      }
      
      // Insert modal HTML
      modalContainer.innerHTML = html;
      
      // Show modal
      const modal = document.getElementById('editBudgetModal');
      if (modal) {
        modal.style.display = 'flex';
        
        // Add escape key listener
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            closeEditModal();
          }
        });
        
        // Add click outside to close
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeEditModal();
          }
        });
      }
    })
    .catch(error => {
      console.error('Error loading modal:', error);
      alert('Error loading edit form');
    });
}

function closeEditModal() {
  const modal = document.getElementById('editBudgetModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// Update the existing entries section to use modal
document.addEventListener('DOMContentLoaded', function() {
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
  
  // Add edit buttons to entries
  document.querySelectorAll('.budget-entry').forEach(entry => {
    const editBtn = entry.querySelector('.edit-entry-btn');
    if (editBtn) {
      const budgetId = editBtn.dataset.budgetId;
      const entryId = editBtn.dataset.entryId;
      editBtn.onclick = function(e) {
        e.preventDefault();
        openEditModal(budgetId, entryId);
      };
    }
  });
});

function showAllocationForm() {
  document.getElementById('allocationForm').style.display = 'block';
}

function hideAllocationForm() {
  document.getElementById('allocationForm').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
});
</script>
{% endblock %}