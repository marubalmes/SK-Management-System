{% extends 'base.html' %}
{% block content %}
<div class="container section panel">
  <!-- Header -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h3 style="margin: 0;">Project Management: {{ project.name }}</h3>
    <a class="btn" href="{{ url_for('projects') }}?sidebar=open" style="margin-left: auto;">← Back to Projects</a>
  </div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <!-- Left Column: Project Details & Updates -->
    <div>
      <!-- Project Edit Form -->
      <div class="card">
        <h4 style="margin-top: 0; display: flex; align-items: center; gap: 8px;">
          <i data-lucide="edit-2" style="width:18px;height:18px;"></i>
          Edit Project Details
        </h4>
        
        <form method="post" enctype="multipart/form-data">
          <div class="form-group">
            <label>Project Name *</label>
            <input class="form-control" name="name" value="{{ project.name }}" required>
          </div>

          <div class="form-group">
            <label>Start Date</label>
            <input class="form-control" name="start_date" type="date" value="{{ project.start_date }}">
          </div>

          <div class="form-group">
            <label>End Date</label>
            <input class="form-control" name="end_date" type="date" value="{{ project.end_date }}">
          </div>

          <div class="form-group">
            <label>Project Details</label>
            <textarea class="form-control" name="details" rows="3" placeholder="Describe the project objectives, scope, and other relevant details...">{{ project.details }}</textarea>
          </div>

          <div class="form-group">
            <label>Status</label>
            <select class="form-control" name="status">
              <option value="Planned" {% if project.status=='Planned' %}selected{% endif %}>Planned</option>
              <option value="On-going" {% if project.status=='On-going' %}selected{% endif %}>On-going</option>
              <option value="Completed" {% if project.status=='Completed' %}selected{% endif %}>Completed</option>
            </select>
          </div>

          <div class="form-group">
            <label>Upload Project Document (optional)</label>
            <input class="form-control" type="file" name="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.csv">
            <small style="color: #666;">Allowed formats: PDF, DOC, DOCX, JPG, PNG, XLSX, CSV</small>
          </div>

          {% if project.filename %}
          <div class="form-group" style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
            <label>Current File:</label>
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
              <a class="btn-outline" href="{{ url_for('uploaded_file', filename=project.filename.replace('uploads/','')) }}" target="_blank">
                <i data-lucide="file" style="width:14px;height:14px;"></i> View Current File
              </a>
              <span style="font-size: 0.9em; color: #666;">Uploading a new file will replace the current one.</span>
            </div>
          </div>
          {% endif %}

          <button type="submit" class="btn" style="width: 100%;">
            <i data-lucide="save" style="width:16px;height:16px;"></i> Update Project Details
          </button>
        </form>
      </div>

      <!-- Project Status & Approval - REMOVED the approval button -->
      <div class="card" style="margin-top: 20px;">
        <h4 style="margin-top: 0; display: flex; align-items: center; gap: 8px;">
          <i data-lucide="clipboard-check" style="width:18px;height:18px;"></i>
          Project Status
        </h4>
        
        <div>
          <div style="margin-bottom: 10px;">
            <strong>Current Status:</strong> 
            <span class="status-badge status-{{ project.status|lower|replace(' ', '-') }}">
              {{ project.status }}
            </span>
          </div>
          
          <div style="margin-bottom: 10px;">
            <strong>SK Chairman Approval:</strong>
            <span class="status-badge {% if project.approved_by_sk_chairman %}status-approved{% else %}status-pending{% endif %}">
              {% if project.approved_by_sk_chairman %}APPROVED{% else %}PENDING{% endif %}
            </span>
            {% if not project.approved_by_sk_chairman %}
            <div style="font-size: 0.85em; color: #666; margin-top: 4px;">
              <i data-lucide="info" style="width:12px;height:12px;"></i>
              Awaiting SK Chairman approval from the Approvals page
            </div>
            {% endif %}
          </div>
          
          <div>
            <strong>Timeline:</strong> {{ project.start_date or 'Not set' }} to {{ project.end_date or 'Not set' }}
          </div>
        </div>
      </div>

      <!-- Add Project Update -->
      <div class="card" style="margin-top: 20px;">
        <h4 style="margin-top: 0; display: flex; align-items: center; gap: 8px;">
          <i data-lucide="message-square" style="width:18px;height:18px;"></i>
          Add Progress Update
        </h4>
        
        <form method="post">
          <input type="hidden" name="add_update" value="true">
          <div class="form-group">
            <label>Update Date:</label>
            <input type="date" name="update_date" class="form-control" value="{{ now.strftime('%Y-%m-%d') }}" required>
          </div>
          <div class="form-group">
            <label>Progress Update:</label>
            <textarea name="update_content" class="form-control" rows="4" placeholder="Describe the progress, challenges, achievements, or next steps..." required></textarea>
          </div>
          <button type="submit" class="btn" style="width: 100%;">
            <i data-lucide="plus" style="width:16px;height:16px;"></i> Add Update
          </button>
        </form>
      </div>
    </div>

    <!-- Right Column: Updates History & Reports -->
    <div>
      <!-- Updates History -->
      <div class="card">
        <h4 style="margin-top: 0; display: flex; align-items: center; gap: 8px;">
          <i data-lucide="clock" style="width:18px;height:18px;"></i>
          Update History
        </h4>
        
        {% if updates %}
          {% for update in updates %}
          <div class="update-item" style="border-left: 4px solid #ff9800; padding: 12px 15px; margin: 10px 0; background: #f9f9f9; border-radius: 0 6px 6px 0; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div>
                {% if update.update_date is string %}
                  <strong style="color: #333;">{{ update.update_date }}</strong>
                {% else %}
                  <strong style="color: #333;">{{ update.update_date.strftime('%Y-%m-%d') if update.update_date else '' }}</strong>
                {% endif %}
                <div style="font-size: 0.85em; color: #666; margin-top: 2px;">
                  by {{ update.fullname }}
                </div>
              </div>
              {% if update.created_by == session.user.id or session.user.role in ['super_admin', 'SK_Chairman'] %}
              <div style="display: flex; gap: 6px;">
                <button class="btn-outline edit-update-btn" 
                        data-update-id="{{ update.id }}"
                        data-update-date="{% if update.update_date is string %}{{ update.update_date }}{% else %}{{ update.update_date.strftime('%Y-%m-%d') if update.update_date else '' }}{% endif %}"
                        data-update-text="{{ update.update_text }}"
                        title="Edit update" style="font-size: 0.8em; padding: 4px 8px;">
                  <i data-lucide="edit" style="width:12px;height:12px;"></i>
                </button>
                <a class="btn-outline" href="{{ url_for('delete_project_update', proj_id=project.id, update_id=update.id) }}" 
                   onclick="return confirm('Are you sure you want to delete this update?')" 
                   title="Delete update" style="font-size: 0.8em; padding: 4px 8px; color:#dc3545; border-color:#dc3545;">
                  <i data-lucide="trash-2" style="width:12px;height:12px;"></i>
                </a>
              </div>
              {% endif %}
            </div>
            <p style="margin: 8px 0 0 0; white-space: pre-wrap; color: #444; line-height: 1.5;">{{ update.update_text }}</p>
          </div>
          {% endfor %}
        {% else %}
          <div style="text-align: center; color: #666; padding: 30px;">
            <i data-lucide="calendar" style="width:48px;height:48px; opacity:0.5; margin-bottom:10px;"></i>
            <p>No updates yet. Add the first progress update!</p>
          </div>
        {% endif %}
      </div>

      <!-- Reports Section -->
      <div class="card" style="margin-top: 20px;">
        <h4 style="margin-top: 0; display: flex; align-items: center; gap: 8px;">
          <i data-lucide="file-text" style="width:18px;height:18px;"></i>
          Project Reports
        </h4>

        <!-- Link Report Form -->
        <form method="POST" action="{{ url_for('link_report_to_project', proj_id=project.id) }}">
          <div class="form-group">
            <label>Link Existing Report:</label>
            <select name="report_id" class="form-control" required>
              <option value="">-- Select a report to link --</option>
              {% for report in available_reports %}
              <option value="{{ report.id }}">
                {{ report.type }} - {{ report.reported_for }} 
                {% if report.uploaded_at %}
                  {% if report.uploaded_at is string %}
                    ({{ report.uploaded_at[:10] if report.uploaded_at|length >= 10 else report.uploaded_at }})
                  {% else %}
                    ({{ report.uploaded_at.strftime('%Y-%m-%d') }})
                  {% endif %}
                {% endif %}
              </option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn" style="width: 100%;">
            <i data-lucide="link" style="width:16px;height:16px;"></i> Link Report
          </button>
        </form>

        <!-- Linked Reports List -->
        <div style="margin-top: 20px;">
          <h5 style="margin-bottom: 12px;">Linked Reports</h5>
          {% if reports %}
            {% for report in reports %}
            <div class="report-item" style="border: 1px solid #e0e0e0; padding: 12px; margin: 8px 0; border-radius: 6px; background: #fff;">
              <div style="display: flex; justify-content: between; align-items: center;">
                <div style="flex: 1;">
                  <strong style="color: #333;">{{ report.type }}</strong>
                  <div style="font-size: 0.85em; color: #666; margin-top: 2px;">
                    {{ report.reported_for }} 
                    {% if report.uploaded_at %}
                      • 
                      {% if report.uploaded_at is string %}
                        {{ report.uploaded_at[:10] if report.uploaded_at|length >= 10 else report.uploaded_at }}
                      {% else %}
                        {{ report.uploaded_at.strftime('%Y-%m-%d') }}
                      {% endif %}
                    {% endif %}
                  </div>
                </div>
                <div style="display: flex; gap: 6px;">
                  {% if report.filename %}
                  <a class="btn-outline" href="{{ url_for('uploaded_file', filename=report.filename.replace('uploads/','')) }}" 
                     target="_blank" title="View report">
                    <i data-lucide="eye" style="width:14px;height:14px;"></i>
                  </a>
                  {% endif %}
                  <a class="btn-outline" href="{{ url_for('unlink_report_from_project', proj_id=project.id, report_id=report.id) }}" 
                     onclick="return confirm('Unlink this report from the project?')" 
                     title="Unlink report" style="color:#dc3545;">
                    <i data-lucide="unlink" style="width:14px;height:14px;"></i>
                  </a>
                </div>
              </div>
              {% if report.notes %}
              <div style="margin-top: 8px; font-size: 0.9em; color: #666; padding-top: 8px; border-top: 1px solid #f0f0f0;">
                {{ report.notes }}
              </div>
              {% endif %}
            </div>
            {% endfor %}
          {% else %}
            <div style="text-align: center; color: #666; padding: 20px;">
              <i data-lucide="file-question" style="width:36px;height:36px; opacity:0.5; margin-bottom:8px;"></i>
              <p>No reports linked yet.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Update Modal -->
<div id="editUpdateModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
        <i data-lucide="edit-2" style="width:18px;height:18px;"></i>
        Edit Project Update
      </h4>
      <button class="modal-close">&times;</button>
    </div>
    <form id="editUpdateForm" method="POST">
      <div class="modal-body">
        <div class="form-group">
          <label>Update Date:</label>
          <input type="date" name="update_date" id="editUpdateDate" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Progress Update:</label>
          <textarea name="update_content" id="editUpdateText" class="form-control" rows="6" placeholder="Describe the progress, challenges, achievements, or next steps..." required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
        <button type="submit" class="btn btn-primary">
          <i data-lucide="save" style="width:16px;height:16px;"></i> Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

<style>
.status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.75em;
  font-weight: bold;
  display: inline-block;
}

.status-planned { background: #fff3cd; color: #856404; }
.status-on-going { background: #d1ecf1; color: #0c5460; }
.status-completed { background: #d4edda; color: #155724; }
.status-approved { background: #d4edda; color: #155724; }
.status-pending { background: #fff3cd; color: #856404; }

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
  color: #333;
}

.btn-outline {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  border: 1px solid #ff9800;
  border-radius: 4px;
  color: #ff9800;
  text-decoration: none;
  font-weight: 500;
  font-size: 0.85em;
  transition: all 0.2s ease;
  background: white;
  cursor: pointer;
}

.btn-outline:hover {
  background: #ff9800;
  color: white;
}

.update-item {
  transition: background-color 0.2s ease;
}

.update-item:hover {
  background: #f0f0f0;
}

.report-item {
  transition: box-shadow 0.2s ease;
}

.report-item:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: white;
  margin: 5% auto;
  padding: 0;
  border-radius: 8px;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  padding: 16px 20px;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h4 {
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-close:hover {
  color: #333;
  background-color: #f0f0f0;
  border-radius: 4px;
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  padding: 16px 20px;
  border-top: 1px solid #e0e0e0;
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.btn-danger {
  background-color: #dc3545;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
}

.btn-danger:hover {
  background-color: #c82333;
}

.btn-secondary {
  background-color: #6c757d;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
}

.btn-secondary:hover {
  background-color: #5a6268;
}

.btn-primary {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
}

.btn-primary:hover {
  background-color: #0069d9;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }

  // Modal elements
  const modal = document.getElementById('editUpdateModal');
  const editForm = document.getElementById('editUpdateForm');
  const editUpdateDate = document.getElementById('editUpdateDate');
  const editUpdateText = document.getElementById('editUpdateText');
  const closeBtn = document.querySelector('.modal-close');
  const cancelBtn = document.getElementById('cancelEditBtn');
  const editButtons = document.querySelectorAll('.edit-update-btn');

  // Open modal when edit button is clicked
  editButtons.forEach(button => {
    button.addEventListener('click', function() {
      const updateId = this.getAttribute('data-update-id');
      const updateDate = this.getAttribute('data-update-date');
      const updateText = this.getAttribute('data-update-text');
      
      // Set form values
      editUpdateDate.value = updateDate;
      editUpdateText.value = updateText;
      
      // Set form action
      editForm.action = "{{ url_for('edit_project_update', proj_id=project.id, update_id=0) }}".replace('0', updateId);
      
      // Show modal
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    });
  });

  // Close modal functions
  function closeModal() {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  closeBtn.addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);

  // Close modal when clicking outside
  window.addEventListener('click', function(event) {
    if (event.target === modal) {
      closeModal();
    }
  });

  // Handle form submission
  editForm.addEventListener('submit', function(e) {
    // Form will submit normally via POST
    closeModal();
  });

  // Escape key to close modal
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal.style.display === 'block') {
      closeModal();
    }
  });
});
</script>
{% endblock %}